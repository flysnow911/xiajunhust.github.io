<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>InfluxDB写入失败-partial write: max-values-per-tag limit exceeded | 江南烟雨的个人博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="最近线上向InfluxDB写入数据突然报错，大概意思是tag的值超限，详细错误信息：
12345678910112016-12-02 20:47:11.485 [] [] [] ERROR c.y.t.p.m.m.i.OrderCreateMonitorManageImpl - InfluxDB写入异常!influxDO=InfluxDO(measurement=com.XXX.trade.cre">
<meta property="og:type" content="article">
<meta property="og:title" content="InfluxDB写入失败-partial write: max-values-per-tag limit exceeded">
<meta property="og:url" content="http://xiajunhust.github.io/2016/12/13/InfluxDB写入失败-partial-write-max-values-per-tag-limit-exceeded/index.html">
<meta property="og:site_name" content="江南烟雨的个人博客">
<meta property="og:description" content="最近线上向InfluxDB写入数据突然报错，大概意思是tag的值超限，详细错误信息：
12345678910112016-12-02 20:47:11.485 [] [] [] ERROR c.y.t.p.m.m.i.OrderCreateMonitorManageImpl - InfluxDB写入异常!influxDO=InfluxDO(measurement=com.XXX.trade.cre">
<meta property="og:updated_time" content="2016-12-17T15:25:36.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="InfluxDB写入失败-partial write: max-values-per-tag limit exceeded">
<meta name="twitter:description" content="最近线上向InfluxDB写入数据突然报错，大概意思是tag的值超限，详细错误信息：
12345678910112016-12-02 20:47:11.485 [] [] [] ERROR c.y.t.p.m.m.i.OrderCreateMonitorManageImpl - InfluxDB写入异常!influxDO=InfluxDO(measurement=com.XXX.trade.cre">
  
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">江南烟雨的个人博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">个人博客</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
      </nav>
      <nav id="sub-nav">
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://xiajunhust.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-InfluxDB写入失败-partial-write-max-values-per-tag-limit-exceeded" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/13/InfluxDB写入失败-partial-write-max-values-per-tag-limit-exceeded/" class="article-date">
  <time datetime="2016-12-13T03:05:46.000Z" itemprop="datePublished">2016-12-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      InfluxDB写入失败-partial write: max-values-per-tag limit exceeded
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>最近线上向InfluxDB写入数据突然报错，大概意思是tag的值超限，详细错误信息：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">2016-12-02 20:47:11.485 [] [] [] ERROR c.y.t.p.m.m.i.OrderCreateMonitorManageImpl - InfluxDB写入异常!influxDO=InfluxDO(measurement=com.XXX.trade.create.request.result, timeStamp=1480682831481, tagKeyList=[cluster, host, count_time, count, count_type], tagValList=[DEFAULT_CLUSTER, xxx-inc.com, 1480682831481, 3, bill_new], fieldKeyList=[result, cost], fieldValList=[true, 112]), exception=&#123;&#125;</div><div class="line">java.lang.RuntimeException: &#123;&quot;error&quot;:&quot;partial write: max-values-per-tag limit exceeded (100000/100000): measurement=\&quot;com.XXX.trade.create.request.result\&quot; tag=\&quot;count_time\&quot; value=\&quot;count_time\&quot; dropped=1&quot;&#125;</div><div class="line"></div><div class="line">    at org.influxdb.impl.InfluxDBImpl.execute(InfluxDBImpl.java:266) ~[influxdb-java-2.4.jar:na]</div><div class="line">    at org.influxdb.impl.InfluxDBImpl.write(InfluxDBImpl.java:167) ~[influxdb-java-2.4.jar:na]</div><div class="line">    at org.influxdb.impl.InfluxDBImpl.write(InfluxDBImpl.java:157) ~[influxdb-java-2.4.jar:na]</div><div class="line">    at com.XXX.trade.process.monitor.dal.impl.InfluxDBDAOImpl.insert(InfluxDBDAOImpl.java:104) ~[trade-process-service-1.0.0-SNAPSHOT.jar:na]</div><div class="line">    at com.XXX.trade.process.monitor.manage.impl.OrderCreateMonitorManageImpl.save(OrderCreateMonitorManageImpl.java:40) ~[trade-process-service-1.0.0-SNAPSHOT.jar:na]</div><div class="line">    at com.XXX.trade.process.nsq.processor.impl.MonitorProcessor.process(MonitorProcessor.java:69) [trade-process-service-1.0.0-SNAPSHOT.jar:na]</div><div class="line">    at com.XXX.trade.process.nsq.NSQSubscriber.lambda$init$0(NSQSubscriber.java:71) [trade-process-service-1.0.0-SNAPSHOT.jar:na]</div><div class="line">    at com.XXX.trade.process.nsq.NSQSubscriber$$Lambda$8/1829287142.process(Unknown Source) [trade-process-service-1.0.0-SNAPSHOT.jar:na]</div></pre></td></tr></table></figure>
<p>Google搜索了下，这是InfluxDB v1.1.0 [2016-11-14]版本新加的一个特性(<a href="https://github.com/influxdata/influxdb/blob/master/CHANGELOG.md" target="_blank" rel="external">CHANGELOG.md</a>)：</p>
<a id="more"></a>
<i><br>max-values-per-tag was added with a default of 100,000, but can be disabled by setting it to 0. Existing measurements with tags that exceed this limit will continue to load, but writes that would cause the tags cardinality to increase will be dropped and a partial write error will be returned to the caller. This limit can be used to prevent high cardinality tag values from being written to a measurement.<br></i>

<p>增加了对tag的值的大小的校验，最大值是10000.若写入的数据的tag的值超限，则调用方会收到报错。用来防止写入到measurement的数据的series-cardinality(<a href="https://docs.influxdata.com/influxdb/v1.1/concepts/glossary/#series-cardinality" target="_blank" rel="external">series-cardinality</a>)过大。</p>
<i><br>关于series cardinality：<br>The number of unique database, measurement, and tag set combinations in an InfluxDB instance.<br></i>

<p><b>这样做的用意是什么呢？</b><br><a href="https://github.com/influxdata/influxdb/issues/7146" target="_blank" rel="external">issue-7146：Add option max-tags-per-database to limit high cardinality data</a>  </p>
<i><br>Much as max-series-per-database in <a href="https://github.com/influxdata/influxdb/pull/7095" target="_blank" rel="external">#7095</a>, add a max-tags-per-database to limit high cardinality data.<br><br>Writes beyond that should be dropped and logged with a rate limit on the log (one summary log per minute or something saying x writes dropped).<br><br>This is important because if you accidentally load in a huge amount of high cardinality data, you can easily get into a place that InfluxDB will OOM if you attempt to delete the data, so your only choice is to try to move the files on disk out the way which deletes other data.<br><br>—<br><br>Configuration setting for managing series cardinality<br><br>Limiting your series cardinality is an essential part of working with InfluxDB. The new max-values-per-tag configuration setting can help you do just that.<br><br>The setting limits the number of tag values allowed per tag key. The default setting is 10,000 (so 10,000 tag values allowed per tag key). If a write causes the number of tag values for a tag key to exceed 10,000, InfluxDB will not write the point and it returns a partial write error.<br></i>

<p>如果我们写入了大量的series-cardinality很高的数据，那么当我们删除数据的时候，InfluxDB会OOM。</p>
<p><b>为什么我们需要关注series cardility？</b><br>原因是InfluxDB在内存中维护了系统中每个series数据的索引。随着具有唯一性的series数据数量的增长，RAM的使用也会增长。过高的series cardinality会导致操作系统kill掉InfluxDB进程，抛出OOM异常。  </p>
<i><br>InfluxDB maintains an in-memory index of every series in the system. As the number of unique series grows, so does the RAM usage. High series cardinality can lead to the operating system killing the InfluxDB process with an out of memory (OOM) exception. See Querying for series cardinality to learn how to query for series cardinality.<br></i>



<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a href="https://github.com/influxdata/influxdb/issues/7146" target="_blank" rel="external">https://github.com/influxdata/influxdb/issues/7146</a></li>
<li><a href="https://github.com/influxdata/influxdb/blob/master/CHANGELOG.md" target="_blank" rel="external">https://github.com/influxdata/influxdb/blob/master/CHANGELOG.md</a></li>
<li><a href="https://www.influxdata.com/tldr-influxdb-tech-tips-november-15-2016/" target="_blank" rel="external">https://www.influxdata.com/tldr-influxdb-tech-tips-november-15-2016/</a></li>
<li><a href="https://docs.influxdata.com/influxdb/v1.1/troubleshooting/frequently-asked-questions/#how-can-i-query-for-series-cardinality" target="_blank" rel="external">FAQ-how-can-i-query-for-series-cardinality</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://xiajunhust.github.io/2016/12/13/InfluxDB写入失败-partial-write-max-values-per-tag-limit-exceeded/" data-id="cjq7vb8r10009bqwf2jt1wnfe" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/InfluxDB/">InfluxDB</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/12/18/从Hystrix-DashboardData看ReativeX的使用/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          从Hystrix DashboardData看ReativeX的使用
        
      </div>
    </a>
  
  
    <a href="/2016/11/17/RocketMQ源码学习之四-PushConsumer/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">RocketMQ源码学习之四-PushConsumer</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    <!-- Featured Tags -->

  
    <!-- Short About -->
<section class="visible-md visible-lg">
    <h5><a href="/about/">ABOUT ME</a></h5>
    <div class="short-about">

        

        

        <!-- SNS Link -->
        <ul class="list-inline">
            
            
            

            

            

            
            
            
            
        </ul>
    </div>
</section>

  
    
  <h5>RECENT POSTS</h3>
  <div class="widget">
    <ul>
      
        <li>
          <a href="/2018/12/25/Spark基础学习笔记4-Spark执行原理分析/">Spark基础学习笔记4-Spark执行原理分析</a>
        </li>
      
        <li>
          <a href="/2018/12/23/Spark基础学习笔记3-广播变量/">Spark基础学习笔记3-广播变量(Broadcast)</a>
        </li>
      
        <li>
          <a href="/2018/12/21/Spark基础学习笔记2-Pair RDD/">Spark基础学习笔记2-Pair RDD</a>
        </li>
      
        <li>
          <a href="/2018/12/20/Spark基础学习笔记1-RDD(弹性分布式数据集) /">Spark基础学习笔记1-RDD(弹性分布式数据集)</a>
        </li>
      
        <li>
          <a href="/2018/12/17/大数据日知录读书笔记-分布式系统-向量时钟算法（Vector_Clock）/">大数据日知录读书笔记-分布式系统-向量时钟算法（Vector_Clock）</a>
        </li>
      
    </ul>
  </div>

  
    <!-- Friends Blog -->

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a><span class="archive-list-count">6</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/09/">九月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">五月 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">十一月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">八月 2016</a><span class="archive-list-count">4</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a><span class="archive-list-count">5</span></li></ul>
    </div>
  </div>


  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 江南烟雨<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>



<script src="/js/script.js"></script>

  </div>
</body>
</html>