<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="null">
    <meta name="keyword"  content="undefined">
    <link rel="shortcut icon" href="/img/ironman-draw.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          为什么Java HashMap、CopyOnWriteArrayList等集合自己实现readObject和writeObject方法 - undefined
        
    </title>

    <link rel="canonical" href="http://xiajunhust.github.io/2016/08/06/为什么Java-HashMap、CopyOnWriteArrayList等集合自己实现readObject和writeObject方法/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS --> 
    <link rel="stylesheet" href="/css/beantech.min.css">
    
    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('undefined')
            /*post*/
        
    }
    
</style>

<header class="intro-header" >
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Java" title="Java">Java</a>
                            
                        </div>
                        <h1>为什么Java HashMap、CopyOnWriteArrayList等集合自己实现readObject和writeObject方法</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by 江南烟雨 on
                            2016-08-06
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>

	
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">江南烟雨的个人博客</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                        <li>
                            <a href="/about/">about</a>
                        </li>
                        
                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>PS:本文源码参考的是JDK 1.8.</p>
<h1 id="1-readObject、writeObject方法是什么？作用是什么？"><a href="#1-readObject、writeObject方法是什么？作用是什么？" class="headerlink" title="1 readObject、writeObject方法是什么？作用是什么？"></a>1 readObject、writeObject方法是什么？作用是什么？</h1><p>当一个class实现了Serializable接口，那么意味着这个类可以被序列化。如果类不实现readObject、writeObject方法，那么会执行默认的序列化和反序列化逻辑，否则执行自定义的序列化和反序列化逻辑，即readObject、writeObject方法的逻辑。</p>
<a id="more"></a>
<p>JDK提供的对于Java对象序列化操作的类是ObjectOutputStream，反序列化的类是ObjectInputStream。下面我们来看序列化的实现（ObjectOutputStream.writeObject）。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Write the specified object to the ObjectOutputStream.  The class of the</div><div class="line"> * object, the signature of the class, and the values of the non-transient</div><div class="line"> * and non-static fields of the class and all of its supertypes are</div><div class="line"> * written.  Default serialization for a class can be overridden using the</div><div class="line"> * writeObject and the readObject methods.  Objects referenced by this</div><div class="line"> * object are written transitively so that a complete equivalent graph of</div><div class="line"> * objects can be reconstructed by an ObjectInputStream.</div><div class="line"> *</div><div class="line"> * &lt;p&gt;Exceptions are thrown for problems with the OutputStream and for</div><div class="line"> * classes that should not be serialized.  All exceptions are fatal to the</div><div class="line"> * OutputStream, which is left in an indeterminate state, and it is up to</div><div class="line"> * the caller to ignore or recover the stream state.</div><div class="line"> *</div><div class="line"> * @throws  InvalidClassException Something is wrong with a class used by</div><div class="line"> *          serialization.</div><div class="line"> * @throws  NotSerializableException Some object to be serialized does not</div><div class="line"> *          implement the java.io.Serializable interface.</div><div class="line"> * @throws  IOException Any exception thrown by the underlying</div><div class="line"> *          OutputStream.</div><div class="line"> */</div><div class="line">public final void writeObject(Object obj) throws IOException &#123;</div><div class="line">    if (enableOverride) &#123;</div><div class="line">        writeObjectOverride(obj);</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    try &#123;</div><div class="line">        writeObject0(obj, false);</div><div class="line">    &#125; catch (IOException ex) &#123;</div><div class="line">        if (depth == 0) &#123;</div><div class="line">            writeFatalException(ex);</div><div class="line">        &#125;</div><div class="line">        throw ex;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从方法注释可以看到，此方法正是执行了将对象序列化的操作。并且默认的序列化机制可以通过重写readObject、writeObject方法实现。实际调用的方法writeObject0最终会调到writeSerialData：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Writes instance data for each serializable class of given object, from</div><div class="line"> * superclass to subclass.</div><div class="line"> */</div><div class="line">private void writeSerialData(Object obj, ObjectStreamClass desc)</div><div class="line">    throws IOException</div><div class="line">&#123;</div><div class="line">    ObjectStreamClass.ClassDataSlot[] slots = desc.getClassDataLayout();</div><div class="line">    for (int i = 0; i &lt; slots.length; i++) &#123;</div><div class="line">        ObjectStreamClass slotDesc = slots[i].desc;</div><div class="line">        //如果类重写了writeObject方法</div><div class="line">        if (slotDesc.hasWriteObjectMethod()) &#123;</div><div class="line">            PutFieldImpl oldPut = curPut;</div><div class="line">            curPut = null;</div><div class="line">            SerialCallbackContext oldContext = curContext;</div><div class="line"></div><div class="line">            if (extendedDebugInfo) &#123;</div><div class="line">                debugInfoStack.push(</div><div class="line">                    &quot;custom writeObject data (class \&quot;&quot; +</div><div class="line">                    slotDesc.getName() + &quot;\&quot;)&quot;);</div><div class="line">            &#125;</div><div class="line">            try &#123;</div><div class="line">                curContext = new SerialCallbackContext(obj, slotDesc);</div><div class="line">                bout.setBlockDataMode(true);</div><div class="line">                //调用实现类自己的writeobject方法</div><div class="line">                slotDesc.invokeWriteObject(obj, this);</div><div class="line">                bout.setBlockDataMode(false);</div><div class="line">                bout.writeByte(TC_ENDBLOCKDATA);</div><div class="line">            &#125; finally &#123;</div><div class="line">                curContext.setUsed();</div><div class="line">                curContext = oldContext;</div><div class="line">                if (extendedDebugInfo) &#123;</div><div class="line">                    debugInfoStack.pop();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            curPut = oldPut;</div><div class="line">        &#125; else &#123;</div><div class="line">            defaultWriteFields(obj, slotDesc);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="2-为什么是private方法？"><a href="#2-为什么是private方法？" class="headerlink" title="2 为什么是private方法？"></a>2 为什么是private方法？</h1><p>javadoc上没有明确说明声明为private的原因，一个可能的原因是，除了子类以外没有其他类会使用它，这样不会被滥用。</p>
<p>另一个原因是，不希望这些方法被子类override。每个类都可以有自己的writeObject方法，序列化引擎会逐一调用。readObject相同。</p>
<h1 id="3-HashMap中对readObject、writeObject方法的实现"><a href="#3-HashMap中对readObject、writeObject方法的实现" class="headerlink" title="3 HashMap中对readObject、writeObject方法的实现"></a>3 HashMap中对readObject、writeObject方法的实现</h1><h2 id="3-1-为什么HashMap要自定义序列化逻辑"><a href="#3-1-为什么HashMap要自定义序列化逻辑" class="headerlink" title="3.1 为什么HashMap要自定义序列化逻辑"></a>3.1 为什么HashMap要自定义序列化逻辑</h2><p>下文是摘自《Effective Java》：</p>
<p><i>For example, consider the case of a hash table. The physical representation is a sequence of hash buckets containing key-value entries. The bucket that an entry resides in is a function of the hash code of its key, which is not, in general, guaranteed to be the same from JVM implementation to JVM implementation. In fact, it isn’t even guaranteed to be the same from run to run. Therefore, accepting the default serialized form for a hash table would constitute a serious bug. Serializing and deserializing the hash table could yield an object whose invariants were seriously corrupt.</i></p>
<p>大概意思是：对于同一个key，在不同的JVM平台上计算出来的hash值可能不同，导致的结果就是，同一个hashmap反序列化之后和序列化之前不同，导致同一个key取出来的值不同。</p>
<h2 id="3-1-HashMap是如何解决的"><a href="#3-1-HashMap是如何解决的" class="headerlink" title="3.1 HashMap是如何解决的"></a>3.1 HashMap是如何解决的</h2><ul>
<li><p>将可能造成数据不一致的元素使用transient修饰，在序列化的时候忽略这些元素：<br><i><br>Entry[] table<br>size<br>modCount<br></i></p>
</li>
<li><p>HashMap中对writeObject的实现：</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Save the state of the &lt;tt&gt;HashMap&lt;/tt&gt; instance to a stream (i.e.,</div><div class="line"> * serialize it).</div><div class="line"> *</div><div class="line"> * @serialData The &lt;i&gt;capacity&lt;/i&gt; of the HashMap (the length of the</div><div class="line"> *             bucket array) is emitted (int), followed by the</div><div class="line"> *             &lt;i&gt;size&lt;/i&gt; (an int, the number of key-value</div><div class="line"> *             mappings), followed by the key (Object) and value (Object)</div><div class="line"> *             for each key-value mapping.  The key-value mappings are</div><div class="line"> *             emitted in no particular order.</div><div class="line"> */</div><div class="line">private void writeObject(java.io.ObjectOutputStream s)</div><div class="line">    throws IOException &#123;</div><div class="line">    int buckets = capacity();</div><div class="line">    // Write out the threshold, loadfactor, and any hidden stuff</div><div class="line">    s.defaultWriteObject();</div><div class="line">    s.writeInt(buckets);</div><div class="line">    s.writeInt(size);</div><div class="line">    internalWriteEntries(s);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Called only from writeObject, to ensure compatible ordering.</div><div class="line">void internalWriteEntries(java.io.ObjectOutputStream s) throws IOException &#123;</div><div class="line">    Node&lt;K,V&gt;[] tab;</div><div class="line">    if (size &gt; 0 &amp;&amp; (tab = table) != null) &#123;</div><div class="line">        for (int i = 0; i &lt; tab.length; ++i) &#123;</div><div class="line">            for (Node&lt;K,V&gt; e = tab[i]; e != null; e = e.next) &#123;</div><div class="line">                s.writeObject(e.key);</div><div class="line">                s.writeObject(e.value);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>HashMap不会将保存数据的数组序列化，而是将元素个数以及每个元素的key、value序列化。而在反序列化的时候，重新计算，填充hashmap：</p>
<p>readObject的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line"> * Reconstitute the &#123;@code HashMap&#125; instance from a stream (i.e.,</div><div class="line"> * deserialize it).</div><div class="line"> */</div><div class="line">private void readObject(java.io.ObjectInputStream s)</div><div class="line">    throws IOException, ClassNotFoundException &#123;</div><div class="line">    // Read in the threshold (ignored), loadfactor, and any hidden stuff</div><div class="line">    s.defaultReadObject();</div><div class="line">    reinitialize();</div><div class="line">    if (loadFactor &lt;= 0 || Float.isNaN(loadFactor))</div><div class="line">        throw new InvalidObjectException(&quot;Illegal load factor: &quot; +</div><div class="line">                                         loadFactor);</div><div class="line">    s.readInt();                // Read and ignore number of buckets</div><div class="line">    int mappings = s.readInt(); // Read number of mappings (size)</div><div class="line">    if (mappings &lt; 0)</div><div class="line">        throw new InvalidObjectException(&quot;Illegal mappings count: &quot; +</div><div class="line">                                         mappings);</div><div class="line">    else if (mappings &gt; 0) &#123; // (if zero, use defaults)</div><div class="line">        // Size the table using given load factor only if within</div><div class="line">        // range of 0.25...4.0</div><div class="line">        float lf = Math.min(Math.max(0.25f, loadFactor), 4.0f);</div><div class="line">        float fc = (float)mappings / lf + 1.0f;</div><div class="line">        int cap = ((fc &lt; DEFAULT_INITIAL_CAPACITY) ?</div><div class="line">                   DEFAULT_INITIAL_CAPACITY :</div><div class="line">                   (fc &gt;= MAXIMUM_CAPACITY) ?</div><div class="line">                   MAXIMUM_CAPACITY :</div><div class="line">                   tableSizeFor((int)fc));</div><div class="line">        float ft = (float)cap * lf;</div><div class="line">        threshold = ((cap &lt; MAXIMUM_CAPACITY &amp;&amp; ft &lt; MAXIMUM_CAPACITY) ?</div><div class="line">                     (int)ft : Integer.MAX_VALUE);</div><div class="line">        @SuppressWarnings(&#123;&quot;rawtypes&quot;,&quot;unchecked&quot;&#125;)</div><div class="line">            Node&lt;K,V&gt;[] tab = (Node&lt;K,V&gt;[])new Node[cap];</div><div class="line">        table = tab;</div><div class="line"></div><div class="line">        // Read the keys and values, and put the mappings in the HashMap</div><div class="line">        for (int i = 0; i &lt; mappings; i++) &#123;</div><div class="line">            @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">                K key = (K) s.readObject();</div><div class="line">            @SuppressWarnings(&quot;unchecked&quot;)</div><div class="line">                V value = (V) s.readObject();</div><div class="line">            putVal(hash(key), key, value, false, false);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样就避免了反序列化之后根据Key获取到的元素与序列化之前获取到的元素不同。</p>
<h1 id="4-为什么CopyOnWriteArrayList也需要自定义序列化逻辑？"><a href="#4-为什么CopyOnWriteArrayList也需要自定义序列化逻辑？" class="headerlink" title="4 为什么CopyOnWriteArrayList也需要自定义序列化逻辑？"></a>4 为什么CopyOnWriteArrayList也需要自定义序列化逻辑？</h1><p>writeObject、readObject实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">  * Saves this list to a stream (that is, serializes it).</div><div class="line">  *</div><div class="line">  * @param s the stream</div><div class="line">  * @throws java.io.IOException if an I/O error occurs</div><div class="line">  * @serialData The length of the array backing the list is emitted</div><div class="line">  *               (int), followed by all of its elements (each an Object)</div><div class="line">  *               in the proper order.</div><div class="line">  */</div><div class="line"> private void writeObject(java.io.ObjectOutputStream s)</div><div class="line">     throws java.io.IOException &#123;</div><div class="line"></div><div class="line">     s.defaultWriteObject();</div><div class="line"></div><div class="line">     Object[] elements = getArray();</div><div class="line">     // Write out array length</div><div class="line">     s.writeInt(elements.length);</div><div class="line"></div><div class="line">     // Write out all elements in the proper order.</div><div class="line">     for (Object element : elements)</div><div class="line">         s.writeObject(element);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> /**</div><div class="line">  * Reconstitutes this list from a stream (that is, deserializes it).</div><div class="line">  * @param s the stream</div><div class="line">  * @throws ClassNotFoundException if the class of a serialized object</div><div class="line">  *         could not be found</div><div class="line">  * @throws java.io.IOException if an I/O error occurs</div><div class="line">  */</div><div class="line"> private void readObject(java.io.ObjectInputStream s)</div><div class="line">     throws java.io.IOException, ClassNotFoundException &#123;</div><div class="line"></div><div class="line">     s.defaultReadObject();</div><div class="line"></div><div class="line">     // bind to new lock</div><div class="line">     resetLock();</div><div class="line"></div><div class="line">     // Read in array length and allocate array</div><div class="line">     int len = s.readInt();</div><div class="line">     Object[] elements = new Object[len];</div><div class="line"></div><div class="line">     // Read in all elements in the proper order.</div><div class="line">     for (int i = 0; i &lt; len; i++)</div><div class="line">         elements[i] = s.readObject();</div><div class="line">     setArray(elements);</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>而数组被声明为transient：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/** The array, accessed only via getArray/setArray. */</div><div class="line">private transient volatile Object[] array;</div></pre></td></tr></table></figure>
<p>可以看出其逻辑和ArrayList相同：是将数组长度以及所有元素序列化，在反序列化的时候新建数组，填充元素。</p>
<p>如果采用默认的序列化机制会有如下问题：存储数据的数组实际上是动态数组，每次在放满以后自动增长设定的长度值，如果数组自动增长长度设为100，而实际只放了一个元素，那就会序列化很多null元素，所以ArrayList把元素数组设置为transient。 </p>
<h1 id="5-参考资料"><a href="#5-参考资料" class="headerlink" title="5 参考资料"></a>5 参考资料</h1><ul>
<li><a href="http://stackoverflow.com/questions/7467313/why-are-readobject-and-writeobject-private-and-why-would-i-write-transient-vari" target="_blank" rel="external">Why are readObject and writeObject private, and why would I write transient variables explicitly?</a></li>
<li><a href="http://www.a-site.cn/article/140346.html" target="_blank" rel="external">http://www.a-site.cn/article/140346.html</a></li>
</ul>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2016/08/27/技术分享-MySQL-InnoDB-locks-and-deadlocks/" data-toggle="tooltip" data-placement="top" title="技术分享-MySQL InnoDB locks and deadlocks">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2016/08/06/CopyOnWriteArrayList与JMM/" data-toggle="tooltip" data-placement="top" title="CopyOnWriteArrayList与JMM">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>









    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; 江南烟雨 2018 
                    <br>
                    Theme by <a href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    re-Ported by <a href="http://beantech.org">BeanTech</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=YenYuHsuan&repo=hexo-theme-beantech&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://xiajunhust.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->






	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="http://xiajunhust.github.io/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
